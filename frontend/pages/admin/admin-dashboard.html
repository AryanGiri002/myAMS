<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - AttendEase</title>
    <link href="/src/output.css" rel="stylesheet" />
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
      body {
        font-family: 'Inter', sans-serif;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Loading Overlay -->
    <div
      id="loading-overlay"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
    >
      <div class="bg-white p-6 rounded-lg shadow-xl">
        <div
          class="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-600 mx-auto"
        ></div>
        <p class="mt-4 text-gray-700">Loading...</p>
      </div>
    </div>

    <!-- Navigation -->
    <nav class="bg-white shadow-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <div class="flex items-center">
            <h1 class="text-xl font-bold text-cyan-600">AttendEase</h1>
            <span class="ml-4 text-sm text-gray-500">Admin Portal</span>
          </div>
          <div class="flex items-center gap-4">
            <div class="text-right">
              <p id="user-name" class="text-sm font-semibold text-gray-900"></p>
              <p id="user-role" class="text-xs text-gray-500"></p>
            </div>
            <button
              onclick="logout()"
              class="text-sm text-red-600 hover:text-red-700 font-medium transition"
            >
              Logout
            </button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Welcome Header -->
      <div class="mb-8">
        <h2 class="text-3xl font-bold text-gray-900 mb-2" id="welcome-message">
          Welcome back, Administrator!
        </h2>
        <p class="text-gray-600">
          Manage users, subjects, classes, and enrollments from your dashboard
        </p>
      </div>

      <!-- Statistics Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Total Users -->
        <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-cyan-500">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500 mb-1">Total Users</p>
              <p id="total-users" class="text-3xl font-bold text-gray-900">0</p>
              <div class="mt-2 flex gap-2 text-xs">
                <span class="text-cyan-600" id="students-count">0 Students</span>
                <span class="text-gray-400">â€¢</span>
                <span class="text-cyan-600" id="teachers-count">0 Teachers</span>
              </div>
            </div>
            <div class="p-3 bg-cyan-100 rounded-lg">
              <svg
                class="w-8 h-8 text-cyan-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"
                />
              </svg>
            </div>
          </div>
        </div>

        <!-- Total Subjects -->
        <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-green-500">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500 mb-1">Total Subjects</p>
              <p id="total-subjects" class="text-3xl font-bold text-gray-900">0</p>
              <p class="mt-2 text-xs text-green-600" id="active-subjects">
                0 Active
              </p>
            </div>
            <div class="p-3 bg-green-100 rounded-lg">
              <svg
                class="w-8 h-8 text-green-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
                />
              </svg>
            </div>
          </div>
        </div>

        <!-- Total Class Sections -->
        <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-purple-500">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500 mb-1">Class Sections</p>
              <p id="total-sections" class="text-3xl font-bold text-gray-900">
                0
              </p>
              <p class="mt-2 text-xs text-purple-600" id="active-sections">
                0 Active
              </p>
            </div>
            <div class="p-3 bg-purple-100 rounded-lg">
              <svg
                class="w-8 h-8 text-purple-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
                />
              </svg>
            </div>
          </div>
        </div>

        <!-- Total Enrollments -->
        <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-yellow-500">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500 mb-1">Active Enrollments</p>
              <p id="total-enrollments" class="text-3xl font-bold text-gray-900">
                0
              </p>
              <p class="mt-2 text-xs text-yellow-600">Student-Subject Pairs</p>
            </div>
            <div class="p-3 bg-yellow-100 rounded-lg">
              <svg
                class="w-8 h-8 text-yellow-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                />
              </svg>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="mb-8">
        <h3 class="text-2xl font-bold text-gray-900 mb-6">Quick Actions</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <a
            href="/pages/admin/admin-users.html"
            class="bg-white rounded-lg shadow-md p-6 hover:shadow-xl transition group"
          >
            <div class="flex items-center gap-4">
              <div class="p-3 bg-cyan-100 rounded-lg group-hover:bg-cyan-200 transition">
                <svg
                  class="w-6 h-6 text-cyan-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"
                  />
                </svg>
              </div>
              <div>
                <p class="font-semibold text-gray-900">Manage Users</p>
                <p class="text-sm text-gray-500">View & edit users</p>
              </div>
            </div>
          </a>

          <a
            href="/pages/admin/admin-subjects.html"
            class="bg-white rounded-lg shadow-md p-6 hover:shadow-xl transition group"
          >
            <div class="flex items-center gap-4">
              <div class="p-3 bg-green-100 rounded-lg group-hover:bg-green-200 transition">
                <svg
                  class="w-6 h-6 text-green-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
                  />
                </svg>
              </div>
              <div>
                <p class="font-semibold text-gray-900">Manage Subjects</p>
                <p class="text-sm text-gray-500">Add & edit subjects</p>
              </div>
            </div>
          </a>

          
          <a
            href="/pages/admin/admin-class-sections.html"
            class="bg-white rounded-lg shadow-md p-6 hover:shadow-xl transition group"
          >
            <div class="flex items-center gap-4">
              <div class="p-3 bg-purple-100 rounded-lg group-hover:bg-purple-200 transition">
                <svg
                  class="w-6 h-6 text-purple-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
                  />
                </svg>
              </div>
              <div>
                <p class="font-semibold text-gray-900">Class Sections</p>
                <p class="text-sm text-gray-500">Manage sections</p>
              </div>
            </div>
          </a>

          <a
            href="/pages/admin/admin-enrollments.html"
            class="bg-white rounded-lg shadow-md p-6 hover:shadow-xl transition group"
          >
            <div class="flex items-center gap-4">
              <div class="p-3 bg-yellow-100 rounded-lg group-hover:bg-yellow-200 transition">
                <svg
                  class="w-6 h-6 text-yellow-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                  />
                </svg>
              </div>
              <div>
                <p class="font-semibold text-gray-900">Enrollments</p>
                <p class="text-sm text-gray-500">Manage enrollments</p>
              </div>
            </div>
          </a>
        </div>
      </div>

      <!-- Recent Activity / System Info -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- System Status -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <h3 class="text-lg font-semibold mb-4">System Status</h3>
          <div class="space-y-3">
            <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
              <div class="flex items-center gap-3">
                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                <span class="font-medium text-gray-900">Database</span>
              </div>
              <span class="text-sm text-green-600">Operational</span>
            </div>
            <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
              <div class="flex items-center gap-3">
                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                <span class="font-medium text-gray-900">API Server</span>
              </div>
              <span class="text-sm text-green-600">Operational</span>
            </div>
            <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
              <div class="flex items-center gap-3">
                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                <span class="font-medium text-gray-900">Authentication</span>
              </div>
              <span class="text-sm text-green-600">Operational</span>
            </div>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <h3 class="text-lg font-semibold mb-4">Quick Statistics</h3>
          <div class="space-y-4">
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span class="text-gray-600">Active Users</span>
                <span class="font-semibold text-gray-900" id="active-users-percent">0%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div
                  id="active-users-bar"
                  class="bg-cyan-600 h-2 rounded-full transition-all duration-500"
                  style="width: 0%"
                ></div>
              </div>
            </div>
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span class="text-gray-600">Subject Utilization</span>
                <span class="font-semibold text-gray-900" id="subject-util-percent">0%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div
                  id="subject-util-bar"
                  class="bg-green-600 h-2 rounded-full transition-all duration-500"
                  style="width: 0%"
                ></div>
              </div>
            </div>
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span class="text-gray-600">Average Class Size</span>
                <span class="font-semibold text-gray-900" id="avg-class-size">0 students</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div
                  id="class-size-bar"
                  class="bg-purple-600 h-2 rounded-full transition-all duration-500"
                  style="width: 0%"
                ></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="/js/constants.js"></script>
    <script src="/js/utils.js"></script>
    <script>
      let currentUser = null;

      document.addEventListener('DOMContentLoaded', async () => {
        currentUser = await checkAuth();
        if (currentUser) {
          checkRole(currentUser, ['admin']);
          initializePage();
        }
      });

      async function initializePage() {
        // Set user info
        document.getElementById('user-name').textContent =
          currentUser.profile.name || 'Administrator';
        document.getElementById('user-role').textContent = 'ADMIN';

        // Load all statistics
        await Promise.all([
          loadUserStats(),
          loadSubjectStats(),
          loadClassSectionStats(),
        ]);
      }

      async function loadUserStats() {
        try {
          const data = await apiRequest(`${API_CONFIG.BASE_URL}/admin/users`);
          const users = data.data.users;

          const totalUsers = users.length;
          const students = users.filter((u) => u.role === 'student').length;
          const teachers = users.filter((u) => u.role === 'teacher').length;
          const activeUsers = users.filter((u) => u.isActive).length;

          animateNumber(document.getElementById('total-users'), totalUsers);
          document.getElementById('students-count').textContent = `${students} Students`;
          document.getElementById('teachers-count').textContent = `${teachers} Teachers`;

          // Active users percentage
          const activePercent = totalUsers > 0 ? Math.round((activeUsers / totalUsers) * 100) : 0;
          document.getElementById('active-users-percent').textContent = `${activePercent}%`;
          setTimeout(() => {
            document.getElementById('active-users-bar').style.width = `${activePercent}%`;
          }, 100);
        } catch (error) {
          console.error('Error loading user stats:', error);
        }
      }

      async function loadSubjectStats() {
        try {
          const data = await apiRequest(`${API_CONFIG.BASE_URL}/admin/subjects`);
          const subjects = data.data.subjects;

          const totalSubjects = subjects.length;
          const activeSubjects = subjects.filter((s) => s.isActive).length;

          animateNumber(document.getElementById('total-subjects'), totalSubjects);
          document.getElementById('active-subjects').textContent = `${activeSubjects} Active`;

          // Subject utilization (active/total)
          const utilPercent = totalSubjects > 0 ? Math.round((activeSubjects / totalSubjects) * 100) : 0;
          document.getElementById('subject-util-percent').textContent = `${utilPercent}%`;
          setTimeout(() => {
            document.getElementById('subject-util-bar').style.width = `${utilPercent}%`;
          }, 100);

          // Calculate enrollments (estimate from subjects)
          const totalEnrollments = subjects.reduce((sum, s) => sum + (s.enrolledStudents || 0), 0);
          animateNumber(document.getElementById('total-enrollments'), totalEnrollments);
        } catch (error) {
          console.error('Error loading subject stats:', error);
        }
      }

      async function loadClassSectionStats() {
        try {
          const data = await apiRequest(`${API_CONFIG.BASE_URL}/admin/class-sections`);
          const sections = data.data.classSections;

          const totalSections = sections.length;
          const activeSections = sections.filter((s) => s.isActive !== false).length;

          animateNumber(document.getElementById('total-sections'), totalSections);
          document.getElementById('active-sections').textContent = `${activeSections} Active`;

          // Calculate average class size
          const totalStudents = sections.reduce((sum, s) => sum + s.totalStudents, 0);
          const avgSize = totalSections > 0 ? Math.round(totalStudents / totalSections) : 0;
          document.getElementById('avg-class-size').textContent = `${avgSize} students`;
          
          // Show as percentage of max (assuming max 60)
          const sizePercent = Math.min(Math.round((avgSize / 60) * 100), 100);
          setTimeout(() => {
            document.getElementById('class-size-bar').style.width = `${sizePercent}%`;
          }, 100);
        } catch (error) {
          console.error('Error loading class section stats:', error);
        }
      }
    </script>
  </body>
</html>