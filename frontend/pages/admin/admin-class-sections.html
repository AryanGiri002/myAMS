<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Class Sections - AttendEase</title>
    <link href="../../src/output.css" rel="stylesheet" />
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
      body {
        font-family: 'Inter', sans-serif;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Loading Overlay -->
    <div
      id="loading-overlay"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
    >
      <div class="bg-white p-6 rounded-lg shadow-xl">
        <div
          class="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-600 mx-auto"
        ></div>
        <p class="mt-4 text-gray-700">Loading...</p>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div
      id="confirm-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
    >
      <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <h3 id="confirm-title" class="text-xl font-bold mb-4"></h3>
        <p id="confirm-message" class="text-gray-700 mb-6"></p>
        <div class="flex gap-3 justify-end">
          <button
            id="confirm-cancel"
            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
          >
            Cancel
          </button>
          <button
            id="confirm-action"
            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
          >
            Confirm
          </button>
        </div>
      </div>
    </div>

    <!-- Create/Edit Class Section Modal -->
    <div
      id="section-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
    >
      <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
          <h3 id="modal-title" class="text-2xl font-bold text-gray-900">
            Create New Class Section
          </h3>
          <button
            onclick="closeSectionModal()"
            class="text-gray-500 hover:text-gray-700"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>

        <form id="section-form" class="space-y-4">
          <input type="hidden" id="edit-section-id" />

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              Subject *
            </label>
            <select
              id="subject-id"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
            >
              <option value="">Select Subject</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              Teacher *
            </label>
            <select
              id="teacher-id"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
            >
              <option value="">Select Teacher</option>
            </select>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                Section Name *
              </label>
              <input
                type="text"
                id="section-name"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                placeholder="e.g., Section A, B, C"
              />
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                Semester *
              </label>
              <select
                id="semester"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
              >
                <option value="">Select Semester</option>
                <option value="1">Semester 1</option>
                <option value="2">Semester 2</option>
                <option value="3">Semester 3</option>
                <option value="4">Semester 4</option>
                <option value="5">Semester 5</option>
                <option value="6">Semester 6</option>
                <option value="7">Semester 7</option>
                <option value="8">Semester 8</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                Academic Year *
              </label>
              <input
                type="text"
                id="academic-year"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                placeholder="e.g., 2024-2025"
              />
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                Max Students
              </label>
              <input
                type="number"
                id="max-students"
                min="1"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                placeholder="e.g., 60"
              />
            </div>
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              Schedule
            </label>
            <textarea
              id="schedule"
              rows="3"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
              placeholder="e.g., Mon 9:00-10:30, Wed 2:00-3:30, Fri 11:00-12:30"
            ></textarea>
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              Room Number
            </label>
            <input
              type="text"
              id="room-number"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
              placeholder="e.g., Room 301"
            />
          </div>

          <div class="flex items-center">
            <input
              type="checkbox"
              id="is-active"
              class="w-4 h-4 text-cyan-600 border-gray-300 rounded focus:ring-cyan-500"
            />
            <label for="is-active" class="ml-2 text-sm font-medium text-gray-700">
              Active Section
            </label>
          </div>

          <div class="flex gap-3 pt-4">
            <button
              type="button"
              onclick="closeSectionModal()"
              class="flex-1 px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium transition"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="flex-1 px-6 py-2 bg-cyan-600 text-white rounded-lg hover:bg-cyan-700 font-medium transition"
            >
              Save Section
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Navigation -->
    <nav class="bg-white shadow-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <div class="flex items-center gap-6">
            <div class="flex items-center">
              <h1 class="text-xl font-bold text-cyan-600">AttendEase</h1>
              <span class="ml-4 text-sm text-gray-500">Admin Portal</span>
            </div>
            <div class="hidden md:flex gap-4">
              
                href="admin-dashboard.html"
                class="text-sm text-gray-600 hover:text-cyan-600 transition"
              >
                Dashboard
              </a>
              
                href="admin-users.html"
                class="text-sm text-gray-600 hover:text-cyan-600 transition"
              >
                Users
              </a>
              
                href="admin-subjects.html"
                class="text-sm text-gray-600 hover:text-cyan-600 transition"
              >
                Subjects
              </a>
              
                href="admin-class-sections.html"
                class="text-sm text-cyan-600 font-semibold"
              >
                Sections
              </a>
              
                href="admin-enrollments.html"
                class="text-sm text-gray-600 hover:text-cyan-600 transition"
              >
                Enrollments
              </a>
            </div>
          </div>
          <div class="flex items-center gap-4">
            <div class="text-right">
              <p id="user-name" class="text-sm font-semibold text-gray-900"></p>
              <p id="user-role" class="text-xs text-gray-500"></p>
            </div>
            <button
              onclick="logout()"
              class="text-sm text-red-600 hover:text-red-700 font-medium transition"
            >
              Logout
            </button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Header -->
      <div class="mb-8">
        <div class="flex justify-between items-center">
          <div>
            <h2 class="text-3xl font-bold text-gray-900">Manage Class Sections</h2>
            <p class="text-gray-600 mt-1">
              Create, view, and manage class sections
            </p>
          </div>
          <button
            onclick="openCreateModal()"
            class="px-6 py-3 bg-cyan-600 text-white rounded-lg hover:bg-cyan-700 font-medium shadow-md hover:shadow-lg transition"
          >
            + Create Section
          </button>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow-sm p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600">Total Sections</p>
              <p id="total-sections" class="text-3xl font-bold text-gray-900 mt-2">0</p>
            </div>
            <div class="p-3 bg-cyan-100 rounded-lg">
              <svg class="w-8 h-8 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600">Active Sections</p>
              <p id="active-sections" class="text-3xl font-bold text-green-600 mt-2">0</p>
            </div>
            <div class="p-3 bg-green-100 rounded-lg">
              <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600">Total Students</p>
              <p id="total-students" class="text-3xl font-bold text-purple-600 mt-2">0</p>
            </div>
            <div class="p-3 bg-purple-100 rounded-lg">
              <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600">Avg Class Size</p>
              <p id="avg-class-size" class="text-3xl font-bold text-yellow-600 mt-2">0</p>
            </div>
            <div class="p-3 bg-yellow-100 rounded-lg">
              <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
            </div>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Search
            </label>
            <input
              type="text"
              id="search-input"
              placeholder="Search by section name..."
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Subject
            </label>
            <select
              id="subject-filter"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
            >
              <option value="">All Subjects</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Semester
            </label>
            <select
              id="semester-filter"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
            >
              <option value="">All Semesters</option>
              <option value="1">Semester 1</option>
              <option value="2">Semester 2</option>
              <option value="3">Semester 3</option>
              <option value="4">Semester 4</option>
              <option value="5">Semester 5</option>
              <option value="6">Semester 6</option>
              <option value="7">Semester 7</option>
              <option value="8">Semester 8</option>
            </select>
          </div>
          <div class="flex items-end">
            <button
              onclick="applyFilters()"
              class="w-full px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-900 transition"
            >
              Apply Filters
            </button>
          </div>
        </div>
      </div>

      <!-- Sections Table -->
      <div class="bg-white rounded-lg shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th
                  class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider"
                >
                  Section Name
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider"
                >
                  Subject
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider"
                >
                  Teacher
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider"
                >
                  Semester
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider"
                >
                  Students
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider"
                >
                  Status
                </th>
                <th
                  class="px-6 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider"
                >
                  Actions
                </th>
              </tr>
            </thead>
            <tbody id="sections-table-body" class="bg-white divide-y divide-gray-200">
              <!-- Sections will be loaded here -->
            </tbody>
          </table>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-12">
          <svg
            class="mx-auto h-12 w-12 text-gray-400"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
            />
          </svg>
          <h3 class="mt-2 text-sm font-medium text-gray-900">No sections found</h3>
          <p class="mt-1 text-sm text-gray-500">
            Get started by creating a new class section.
          </p>
        </div>
      </div>

      <!-- Pagination -->
      <div
        id="pagination"
        class="hidden mt-6 flex items-center justify-between"
      >
        <div class="text-sm text-gray-700">
          Showing <span id="showing-from" class="font-medium">1</span> to
          <span id="showing-to" class="font-medium">10</span> of
          <span id="total-count" class="font-medium">0</span> sections
        </div>
        <div class="flex gap-2">
          <button
            id="prev-page"
            onclick="previousPage()"
            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Previous
          </button>
          <button
            id="next-page"
            onclick="nextPage()"
            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Next
          </button>
        </div>
      </div>
    </div>

    <script src="/js/utils.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script>
      let allSections = [];
      let filteredSections = [];
      let allSubjects = [];
      let allTeachers = [];
      let currentPage = 1;
      const sectionsPerPage = 10;

      // Initialize page
      async function initializePage() {
        checkAuth();
        const user = getCurrentUser();
        if (!user || user.role !== 'admin') {
          showToast('Access denied. Admin privileges required.', 'error');
          setTimeout(() => {
            window.location.href = '/login.html';
          }, 1500);
          return;
        }

        document.getElementById('user-name').textContent = `${user.firstName} ${user.lastName}`;
        document.getElementById('user-role').textContent = user.role.toUpperCase();

        await Promise.all([
          loadSections(),
          loadSubjects(),
          loadTeachers()
        ]);
      }

      // Load all sections
      async function loadSections() {
        showLoading();
        try {
          const response = await apiRequest('/admin/class-sections', 'GET');
          allSections = response.classSections || [];
          filteredSections = [...allSections];
          
          updateStats();
          renderSections();
          hideLoading();
        } catch (error) {
          hideLoading();
          showToast(error.message || 'Failed to load sections', 'error');
        }
      }

      // Load subjects for dropdown
      async function loadSubjects() {
        try {
          const response = await apiRequest('/admin/subjects', 'GET');
          allSubjects = response.subjects || [];
          populateSubjectDropdowns();
        } catch (error) {
          console.error('Failed to load subjects:', error);
        }
      }

      // Load teachers for dropdown
      async function loadTeachers() {
        try {
          const response = await apiRequest('/admin/users', 'GET');
          allTeachers = (response.users || []).filter(u => u.role === 'teacher');
          populateTeacherDropdown();
        } catch (error) {
          console.error('Failed to load teachers:', error);
        }
      }

      // Populate subject dropdowns
      function populateSubjectDropdowns() {
        const subjectSelect = document.getElementById('subject-id');
        const subjectFilter = document.getElementById('subject-filter');
        
        // Clear existing options (except first)
        subjectSelect.innerHTML = '<option value="">Select Subject</option>';
        subjectFilter.innerHTML = '<option value="">All Subjects</option>';
        
        allSubjects.forEach(subject => {
          const option1 = document.createElement('option');
          option1.value = subject._id;
          option1.textContent = `${subject.subjectCode} - ${subject.subjectName}`;
          subjectSelect.appendChild(option1);

          const option2 = document.createElement('option');
          option2.value = subject._id;
          option2.textContent = `${subject.subjectCode} - ${subject.subjectName}`;
          subjectFilter.appendChild(option2);
        });
      }

      // Populate teacher dropdown
      function populateTeacherDropdown() {
        const teacherSelect = document.getElementById('teacher-id');
        teacherSelect.innerHTML = '<option value="">Select Teacher</option>';
        
        allTeachers.forEach(teacher => {
          const option = document.createElement('option');
          option.value = teacher._id;
          option.textContent = `${teacher.firstName} ${teacher.lastName}`;
          teacherSelect.appendChild(option);
        });
      }

      // Update stats
      function updateStats() {
        const totalSections = allSections.length;
        const activeSections = allSections.filter(s => s.isActive).length;
        const totalStudents = allSections.reduce((sum, s) => sum + (s.enrolledStudents || 0), 0);
        const avgClassSize = totalSections > 0 
          ? Math.round(totalStudents / totalSections)
          : 0;

        document.getElementById('total-sections').textContent = totalSections;
        document.getElementById('active-sections').textContent = activeSections;
        document.getElementById('total-students').textContent = totalStudents;
        document.getElementById('avg-class-size').textContent = avgClassSize;
      }

      // Get subject name by ID
      function getSubjectName(subjectId) {
        const subject = allSubjects.find(s => s._id === subjectId);
        return subject ? `${subject.subjectCode} - ${subject.subjectName}` : 'Unknown';
      }

      // Get teacher name by ID
      function getTeacherName(teacherId) {
        const teacher = allTeachers.find(t => t._id === teacherId);
        return teacher ? `${teacher.firstName} ${teacher.lastName}` : 'Unknown';
      }

      // Render sections table
      function renderSections() {
        const tbody = document.getElementById('sections-table-body');
        const emptyState = document.getElementById('empty-state');
        const pagination = document.getElementById('pagination');

        if (filteredSections.length === 0) {
          tbody.innerHTML = '';
          emptyState.classList.remove('hidden');
          pagination.classList.add('hidden');
          return;
        }

        emptyState.classList.add('hidden');
        pagination.classList.remove('hidden');

        const startIndex = (currentPage - 1) * sectionsPerPage;
        const endIndex = startIndex + sectionsPerPage;
        const sectionsToShow = filteredSections.slice(startIndex, endIndex);

        tbody.innerHTML = sectionsToShow
          .map(
            (section) => `
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-semibold text-cyan-600">${section.sectionName}</div>
              <div class="text-xs text-gray-500">${section.academicYear}</div>
            </td>
            <td class="px-6 py-4">
              <div class="text-sm text-gray-900">${getSubjectName(section.subjectId)}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">${getTeacherName(section.teacherId)}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                Sem ${section.semester}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">
                ${section.enrolledStudents || 0}${section.maxStudents ? ` / ${section.maxStudents}` : ''}
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${section.isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                ${section.isActive ? 'Active' : 'Inactive'}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              <button
                onclick="editSection('${section._id}')"
                class="text-cyan-600 hover:text-cyan-900 mr-3"
              >
                Edit
              </button>
              <button
                onclick="deleteSection('${section._id}', '${section.sectionName}')"
                class="text-red-600 hover:text-red-900"
              >
                Delete
              </button>
            </td>
          </tr>
        `
          )
          .join('');

        // Update pagination info
        document.getElementById('showing-from').textContent = startIndex + 1;
        document.getElementById('showing-to').textContent = Math.min(
          endIndex,
          filteredSections.length
        );
        document.getElementById('total-count').textContent = filteredSections.length;

        // Update pagination buttons
        document.getElementById('prev-page').disabled = currentPage === 1;
        document.getElementById('next-page').disabled =
          endIndex >= filteredSections.length;
      }

      // Open create modal
      function openCreateModal() {
        document.getElementById('modal-title').textContent = 'Create New Class Section';
        document.getElementById('section-form').reset();
        document.getElementById('edit-section-id').value = '';
        document.getElementById('is-active').checked = true;
        document.getElementById('section-modal').classList.remove('hidden');
      }

      // Close section modal
      function closeSectionModal() {
        document.getElementById('section-modal').classList.add('hidden');
      }

      // Edit section
      async function editSection(sectionId) {
        const section = allSections.find((s) => s._id === sectionId);
        if (!section) return;

        document.getElementById('modal-title').textContent = 'Edit Class Section';
        document.getElementById('edit-section-id').value = section._id;
        document.getElementById('subject-id').value = section.subjectId;
        document.getElementById('teacher-id').value = section.teacherId;
        document.getElementById('section-name').value = section.sectionName;
        document.getElementById('semester').value = section.semester;
        document.getElementById('academic-year').value = section.academicYear;
        document.getElementById('max-students').value = section.maxStudents || '';
        document.getElementById('schedule').value = section.schedule || '';
        document.getElementById('room-number').value = section.roomNumber || '';
        document.getElementById('is-active').checked = section.isActive;

        document.getElementById('section-modal').classList.remove('hidden');
      }

      // Handle form submit
      document.getElementById('section-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const editSectionId = document.getElementById('edit-section-id').value;

        const sectionData = {
          subjectId: document.getElementById('subject-id').value,
          teacherId: document.getElementById('teacher-id').value,
          sectionName: document.getElementById('section-name').value,
          semester: parseInt(document.getElementById('semester').value),
          academicYear: document.getElementById('academic-year').value,
          isActive: document.getElementById('is-active').checked,
        };

        // Add optional fields if provided
        const maxStudents = document.getElementById('max-students').value;
        if (maxStudents) {
          sectionData.maxStudents = parseInt(maxStudents);
        }

        const schedule = document.getElementById('schedule').value;
        if (schedule) {
          sectionData.schedule = schedule;
        }

        const roomNumber = document.getElementById('room-number').value;
        if (roomNumber) {
          sectionData.roomNumber = roomNumber;
        }

        showLoading();
        try {
          if (editSectionId) {
            // Update section
            await apiRequest(`/admin/class-sections/${editSectionId}`, 'PUT', sectionData);
            showToast('Section updated successfully', 'success');
          } else {
            // Create section
            await apiRequest('/admin/class-sections', 'POST', sectionData);
            showToast('Section created successfully', 'success');
          }

          closeSectionModal();
          await loadSections();
        } catch (error) {
          hideLoading();
          showToast(error.message || 'Failed to save section', 'error');
        }
      });

      // Delete section
      function deleteSection(sectionId, sectionName) {
        showConfirmModal(
          'Delete Class Section',
          `Are you sure you want to delete ${sectionName}? This action cannot be undone.`,
          async () => {
            showLoading();
            try {
              await apiRequest(`/admin/class-sections/${sectionId}`, 'DELETE');
              showToast('Section deleted successfully', 'success');
              await loadSections();
            } catch (error) {
              hideLoading();
              showToast(error.message || 'Failed to delete section', 'error');
            }
          }
        );
      }

      // Apply filters
      function applyFilters() {
        const searchTerm = document
          .getElementById('search-input')
          .value.toLowerCase();
        const subjectFilter = document.getElementById('subject-filter').value;
        const semesterFilter = document.getElementById('semester-filter').value;

        filteredSections = allSections.filter((section) => {
          const matchesSearch = section.sectionName.toLowerCase().includes(searchTerm);
          const matchesSubject = !subjectFilter || section.subjectId === subjectFilter;
          const matchesSemester = !semesterFilter || section.semester == semesterFilter;

          return matchesSearch && matchesSubject && matchesSemester;
        });

        currentPage = 1;
        renderSections();
      }

      // Pagination
      function previousPage() {
        if (currentPage > 1) {
          currentPage--;
          renderSections();
        }
      }

      function nextPage() {
        if (currentPage * sectionsPerPage < filteredSections.length) {
          currentPage++;
          renderSections();
        }
      }

      // Initialize when page loads
      document.addEventListener('DOMContentLoaded', initializePage);
    </script>
  </body>
</html>