<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Subjects - AttendEase</title>
    <link href="../../src/output.css" rel="stylesheet" />
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
      body {
        font-family: 'Inter', sans-serif;
      }
    </style>
  </head>

  <body class="bg-gray-50">
    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Loading Overlay -->
    <div
      id="loading-overlay"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
    >
      <div class="bg-white p-6 rounded-lg shadow-xl">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-600 mx-auto"></div>
        <p class="mt-4 text-gray-700">Loading...</p>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div
      id="confirm-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
    >
      <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <h3 id="confirm-title" class="text-xl font-bold mb-4"></h3>
        <p id="confirm-message" class="text-gray-700 mb-6"></p>
        <div class="flex gap-3 justify-end">
          <button id="confirm-cancel" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
            Cancel
          </button>
          <button id="confirm-action" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
            Confirm
          </button>
        </div>
      </div>
    </div>

    <!-- Create/Edit Subject Modal -->
    <div id="subject-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
      <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
          <h3 id="modal-title" class="text-2xl font-bold text-gray-900">Create New Subject</h3>
          <button onclick="closeSubjectModal()" class="text-gray-500 hover:text-gray-700">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <form id="subject-form" class="space-y-4">
          <input type="hidden" id="edit-subject-id" />

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Subject Code *</label>
            <input
              type="text"
              id="subject-code"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500"
              placeholder="e.g., CS101"
            />
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Subject Name *</label>
            <input
              type="text"
              id="subject-name"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500"
              placeholder="e.g., Data Structures"
            />
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Credits *</label>
              <input
                type="number"
                id="credits"
                min="1"
                max="10"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg"
              />
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Semester *</label>
              <select id="semester" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                <option value="">Select Semester</option>
                <option value="1">Semester 1</option>
                <option value="2">Semester 2</option>
                <option value="3">Semester 3</option>
                <option value="4">Semester 4</option>
                <option value="5">Semester 5</option>
                <option value="6">Semester 6</option>
                <option value="7">Semester 7</option>
                <option value="8">Semester 8</option>
              </select>
            </div>
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Department *</label>
            <input
              type="text"
              id="department"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg"
              placeholder="e.g., Computer Science"
            />
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
            <textarea
              id="description"
              rows="3"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg"
              placeholder="Brief description..."
            ></textarea>
          </div>

          <div class="flex items-center">
            <input type="checkbox" id="is-active" class="w-4 h-4 text-cyan-600" />
            <label class="ml-2 text-sm text-gray-700">Active Subject</label>
          </div>

          <div class="flex gap-3 pt-4">
            <button type="button" onclick="closeSubjectModal()" class="flex-1 px-6 py-2 border rounded-lg">Cancel</button>
            <button type="submit" class="flex-1 px-6 py-2 bg-cyan-600 text-white rounded-lg">Save Subject</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Navigation -->
    <nav class="bg-white shadow-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <div class="flex items-center gap-6">
            <h1 class="text-xl font-bold text-cyan-600">AttendEase</h1>
            <span class="text-sm text-gray-500">Admin Portal</span>

            <div class="hidden md:flex gap-4">
              <a href="admin-dashboard.html" class="text-sm text-gray-600 hover:text-cyan-600">Dashboard</a>
              <a href="admin-users.html" class="text-sm text-gray-600 hover:text-cyan-600">Users</a>
              <a href="admin-subjects.html" class="text-sm text-cyan-600 font-semibold">Subjects</a>
              <a href="admin-class-sections.html" class="text-sm text-gray-600 hover:text-cyan-600">Sections</a>
              <a href="admin-enrollments.html" class="text-sm text-gray-600 hover:text-cyan-600">Enrollments</a>
            </div>
          </div>

          <div class="flex items-center gap-4">
            <div class="text-right">
              <p id="user-name" class="text-sm font-semibold text-gray-900"></p>
              <p id="user-role" class="text-xs text-gray-500"></p>
            </div>
            <button onclick="logout()" class="text-sm text-red-600 hover:text-red-700">Logout</button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div class="mb-8 flex justify-between items-center">
        <div>
          <h2 class="text-3xl font-bold text-gray-900">Manage Subjects</h2>
          <p class="text-gray-600 mt-1">Create, view, and manage course subjects</p>
        </div>
        <button onclick="openCreateModal()" class="px-6 py-3 bg-cyan-600 text-white rounded-lg">+ Create Subject</button>
      </div>

      <!-- Stats -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow p-6">
          <p class="text-sm text-gray-600">Total Subjects</p>
          <p id="total-subjects" class="text-3xl font-bold mt-2">0</p>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
          <p class="text-sm text-gray-600">Active Subjects</p>
          <p id="active-subjects" class="text-3xl font-bold text-green-700 mt-2">0</p>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
          <p class="text-sm text-gray-600">Departments</p>
          <p id="total-departments" class="text-3xl font-bold text-purple-700 mt-2">0</p>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
          <p class="text-sm text-gray-600">Avg Credits</p>
          <p id="avg-credits" class="text-3xl font-bold text-yellow-700 mt-2">0</p>
        </div>
      </div>

      <!-- Filters -->
      <div class="bg-white rounded-lg shadow p-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div>
            <label class="block text-sm font-medium">Search</label>
            <input type="text" id="search-input" class="w-full px-4 py-2 border rounded-lg" />
          </div>

          <div>
            <label class="block text-sm font-medium">Department</label>
            <select id="department-filter" class="w-full px-4 py-2 border rounded-lg">
              <option value="">All Departments</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium">Semester</label>
            <select id="semester-filter" class="w-full px-4 py-2 border rounded-lg">
              <option value="">All Semesters</option>
              <option value="1">Semester 1</option>
              <option value="2">Semester 2</option>
              <option value="3">Semester 3</option>
              <option value="4">Semester 4</option>
              <option value="5">Semester 5</option>
              <option value="6">Semester 6</option>
              <option value="7">Semester 7</option>
              <option value="8">Semester 8</option>
            </select>
          </div>

          <div class="flex items-end">
            <button onclick="applyFilters()" class="w-full px-4 py-2 bg-gray-800 text-white rounded-lg">
              Apply Filters
            </button>
          </div>
        </div>
      </div>

      <!-- Subjects Table -->
      <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-semibold">Subject Code</th>
                <th class="px-6 py-3 text-left text-xs font-semibold">Subject Name</th>
                <th class="px-6 py-3 text-left text-xs font-semibold">Department</th>
                <th class="px-6 py-3 text-left text-xs font-semibold">Semester</th>
                <th class="px-6 py-3 text-left text-xs font-semibold">Credits</th>
                <th class="px-6 py-3 text-left text-xs font-semibold">Status</th>
                <th class="px-6 py-3 text-right text-xs font-semibold">Actions</th>
              </tr>
            </thead>
            <tbody id="subjects-table-body" class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-12">
          <h3 class="text-sm font-medium">No subjects found</h3>
          <p class="text-sm text-gray-500">Try adjusting your filters.</p>
        </div>
      </div>

      <!-- Pagination -->
      <div id="pagination" class="hidden mt-6 flex items-center justify-between">
        <p class="text-sm text-gray-700">
          Showing <span id="showing-from">1</span> to <span id="showing-to">10</span> of
          <span id="total-count">0</span> subjects
        </p>

        <div class="flex gap-2">
          <button id="prev-page" onclick="previousPage()" class="px-4 py-2 border rounded-lg">Previous</button>
          <button id="next-page" onclick="nextPage()" class="px-4 py-2 border rounded-lg">Next</button>
        </div>
      </div>
    </div>

    <!-- Correct Scripts -->
    <script src="../../js/constants.js"></script>
    <script src="../../js/utils.js"></script>

    <script>
      /* =============================
         STATE
      ==============================*/
      let allSubjects = [];
      let filteredSubjects = [];
      let currentPage = 1;
      const subjectsPerPage = 10;

      /* =============================
         INIT
      ==============================*/
      document.addEventListener('DOMContentLoaded', initializePage);

      async function initializePage() {
        console.log('Initialize Subjects Page');

        const currentUser = await checkAuth();
        if (!currentUser) return;

        checkRole(currentUser, ['admin']);

        document.getElementById('user-name').textContent =
          currentUser.profile?.name || currentUser.email;
        document.getElementById('user-role').textContent =
          currentUser.role.toUpperCase();

        await loadSubjects();
      }

      /* =============================
         LOAD SUBJECTS
      ==============================*/
      async function loadSubjects() {
        showLoading();
        try {
          const res = await apiRequest(`${API_CONFIG.BASE_URL}/admin/subjects`, { method: 'GET' });
          console.log('Subjects API Response:', res);

          allSubjects = res.data?.subjects || [];
          filteredSubjects = [...allSubjects];

          updateStats();
          populateDepartmentFilter();
          renderSubjects();

        } catch (err) {
          console.error('Failed to load subjects:', err);
          showToast(err.message || 'Failed to load subjects', 'error');
        }
        hideLoading();
      }

      /* =============================
         STATS
      ==============================*/
      function updateStats() {
        const totalSubjects = allSubjects.length;
        const activeSubjects = allSubjects.filter((s) => s.isActive).length;
        const departments = new Set(allSubjects.map((s) => s.branch)).size;
        const avgCredits =
          totalSubjects > 0
            ? (allSubjects.reduce((sum, s) => sum + s.credits, 0) / totalSubjects).toFixed(1)
            : 0;

        document.getElementById('total-subjects').textContent = totalSubjects;
        document.getElementById('active-subjects').textContent = activeSubjects;
        document.getElementById('total-departments').textContent = departments;
        document.getElementById('avg-credits').textContent = avgCredits;
      }

      /* =============================
         DEPARTMENT FILTER
      ==============================*/
      function populateDepartmentFilter() {
        const select = document.getElementById('department-filter');
        select.innerHTML = '<option value="">All Departments</option>';

        const departments = [...new Set(allSubjects.map((s) => s.branch))].sort();
        departments.forEach((dept) => {
          const option = document.createElement('option');
          option.value = dept;
          option.textContent = dept;
          select.appendChild(option);
        });
      }

      /* =============================
         RENDER TABLE
      ==============================*/
      function renderSubjects() {
        const tbody = document.getElementById('subjects-table-body');
        const emptyState = document.getElementById('empty-state');
        const pagination = document.getElementById('pagination');

        if (filteredSubjects.length === 0) {
          tbody.innerHTML = '';
          emptyState.classList.remove('hidden');
          pagination.classList.add('hidden');
          return;
        }

        emptyState.classList.add('hidden');
        pagination.classList.remove('hidden');

        const start = (currentPage - 1) * subjectsPerPage;
        const end = start + subjectsPerPage;
        const items = filteredSubjects.slice(start, end);

        tbody.innerHTML = items
          .map(
            (s) => `
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4">${s.subjectCode}</td>
            <td class="px-6 py-4">
              <div class="font-medium">${s.subjectName}</div>
              ${s.description ? `<div class="text-xs text-gray-500">${s.description}</div>` : ''}
            </td>
            <td class="px-6 py-4">${s.branch}</td>
            <td class="px-6 py-4">Sem ${s.semester}</td>
            <td class="px-6 py-4">${s.credits}</td>
            <td class="px-6 py-4">
              <span class="px-3 py-1 rounded-full text-xs ${
                s.isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
              }">
                ${s.isActive ? 'Active' : 'Inactive'}
              </span>
            </td>
            <td class="px-6 py-4 text-right">
              <button onclick="editSubject('${s._id}')" class="text-cyan-600 mr-3">Edit</button>
              <button onclick="deleteSubject('${s._id}', '${s.subjectCode}')" class="text-red-600">Delete</button>
            </td>
          </tr>`
          )
          .join('');

        document.getElementById('showing-from').textContent = start + 1;
        document.getElementById('showing-to').textContent = Math.min(end, filteredSubjects.length);
        document.getElementById('total-count').textContent = filteredSubjects.length;

        document.getElementById('prev-page').disabled = currentPage === 1;
        document.getElementById('next-page').disabled = end >= filteredSubjects.length;
      }

      /* =============================
         MODALS
      ==============================*/
      function openCreateModal() {
        document.getElementById('modal-title').textContent = 'Create New Subject';
        document.getElementById('subject-form').reset();
        document.getElementById('edit-subject-id').value = '';
        document.getElementById('is-active').checked = true;
        document.getElementById('subject-modal').classList.remove('hidden');
      }

      function closeSubjectModal() {
        document.getElementById('subject-modal').classList.add('hidden');
      }

      function editSubject(id) {
        const s = allSubjects.find((x) => x._id === id);
        if (!s) return;

        document.getElementById('modal-title').textContent = 'Edit Subject';

        document.getElementById('edit-subject-id').value = s._id;
        document.getElementById('subject-code').value = s.subjectCode;
        document.getElementById('subject-name').value = s.subjectName;
        document.getElementById('credits').value = s.credits;
        document.getElementById('semester').value = s.semester;
        document.getElementById('department').value = s.department;
        document.getElementById('description').value = s.description || '';
        document.getElementById('is-active').checked = s.isActive;

        document.getElementById('subject-modal').classList.remove('hidden');
      }

      /* =============================
         SAVE SUBJECT
      ==============================*/
      document.getElementById('subject-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        showLoading();

        const id = document.getElementById('edit-subject-id').value;

        const payload = {
          subjectCode: document.getElementById('subject-code').value,
          subjectName: document.getElementById('subject-name').value,
          credits: Number(document.getElementById('credits').value),
          semester: Number(document.getElementById('semester').value),
          department: document.getElementById('department').value,
          description: document.getElementById('description').value,
          isActive: document.getElementById('is-active').checked,
        };

        try {
          if (id) {
            await apiRequest(`${API_CONFIG.BASE_URL}/admin/subjects/${id}`, {
              method: 'PUT',
              body: JSON.stringify(payload),
            });
            showToast('Subject updated successfully', 'success');
          } else {
            await apiRequest(`${API_CONFIG.BASE_URL}/admin/subjects`, {
              method: 'POST',
              body: JSON.stringify(payload),
            });
            showToast('Subject created successfully', 'success');
          }

          closeSubjectModal();
          await loadSubjects();
        } catch (err) {
          console.error(err);
          showToast(err.message || 'Failed to save subject', 'error');
        }

        hideLoading();
      });

      /* =============================
         DELETE
      ==============================*/
      function deleteSubject(id, code) {
        showConfirmModal(
          'Delete Subject',
          `Are you sure you want to delete ${code}?`,
          async () => {
            try {
              await apiRequest(`${API_CONFIG.BASE_URL}/admin/subjects/${id}`, { method: 'DELETE' });
              showToast('Subject deleted', 'success');
              await loadSubjects();
            } catch (err) {
              showToast(err.message || 'Failed to delete subject', 'error');
            }
          }
        );
      }

      /* =============================
         FILTERS
      ==============================*/
      function applyFilters() {
        const search = document.getElementById('search-input').value.toLowerCase();
        const dept = document.getElementById('department-filter').value;
        const sem = document.getElementById('semester-filter').value;

        filteredSubjects = allSubjects.filter((s) => {
          const matchesSearch =
            s.subjectCode.toLowerCase().includes(search) ||
            s.subjectName.toLowerCase().includes(search);

          const matchesDept = !dept || s.department === dept;
          const matchesSem = !sem || s.semester == sem;

          return matchesSearch && matchesDept && matchesSem;
        });

        currentPage = 1;
        renderSubjects();
      }

      /* =============================
         PAGINATION
      ==============================*/
      function previousPage() {
        if (currentPage > 1) {
          currentPage--;
          renderSubjects();
        }
      }

      function nextPage() {
        if (currentPage * subjectsPerPage < filteredSubjects.length) {
          currentPage++;
          renderSubjects();
        }
      }
    </script>
  </body>
</html>
