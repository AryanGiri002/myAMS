<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Subjects - AttendEase</title>
    <link href="../../src/output.css" rel="stylesheet" />
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
      body {
        font-family: 'Inter', sans-serif;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Loading Overlay -->
    <div
      id="loading-overlay"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
    >
      <div class="bg-white p-6 rounded-lg shadow-xl">
        <div
          class="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-600 mx-auto"
        ></div>
        <p class="mt-4 text-gray-700">Loading...</p>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div
      id="confirm-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
    >
      <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <h3 id="confirm-title" class="text-xl font-bold mb-4"></h3>
        <p id="confirm-message" class="text-gray-700 mb-6"></p>
        <div class="flex gap-3 justify-end">
          <button
            id="confirm-cancel"
            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
          >
            Cancel
          </button>
          <button
            id="confirm-action"
            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
          >
            Confirm
          </button>
        </div>
      </div>
    </div>

    <!-- Create/Edit Subject Modal -->
    <div
      id="subject-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
    >
      <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
          <h3 id="modal-title" class="text-2xl font-bold text-gray-900">
            Create New Subject
          </h3>
          <button
            onclick="closeSubjectModal()"
            class="text-gray-500 hover:text-gray-700"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>

        <form id="subject-form" class="space-y-4">
          <input type="hidden" id="edit-subject-id" />

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              Subject Code *
            </label>
            <input
              type="text"
              id="subject-code"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
              placeholder="e.g., CS101"
            />
            <p class="text-xs text-gray-500 mt-1">
              Unique identifier for the subject
            </p>
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              Subject Name *
            </label>
            <input
              type="text"
              id="subject-name"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
              placeholder="e.g., Data Structures and Algorithms"
            />
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                Credits *
              </label>
              <input
                type="number"
                id="credits"
                required
                min="1"
                max="10"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                placeholder="e.g., 4"
              />
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                Semester *
              </label>
              <select
                id="semester"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
              >
                <option value="">Select Semester</option>
                <option value="1">Semester 1</option>
                <option value="2">Semester 2</option>
                <option value="3">Semester 3</option>
                <option value="4">Semester 4</option>
                <option value="5">Semester 5</option>
                <option value="6">Semester 6</option>
                <option value="7">Semester 7</option>
                <option value="8">Semester 8</option>
              </select>
            </div>
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              Department *
            </label>
            <input
              type="text"
              id="department"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
              placeholder="e.g., Computer Science"
            />
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              Description
            </label>
            <textarea
              id="description"
              rows="3"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
              placeholder="Brief description of the subject (optional)"
            ></textarea>
          </div>

          <div class="flex items-center">
            <input
              type="checkbox"
              id="is-active"
              class="w-4 h-4 text-cyan-600 border-gray-300 rounded focus:ring-cyan-500"
            />
            <label for="is-active" class="ml-2 text-sm font-medium text-gray-700">
              Active Subject
            </label>
          </div>

          <div class="flex gap-3 pt-4">
            <button
              type="button"
              onclick="closeSubjectModal()"
              class="flex-1 px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium transition"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="flex-1 px-6 py-2 bg-cyan-600 text-white rounded-lg hover:bg-cyan-700 font-medium transition"
            >
              Save Subject
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Navigation -->
    <nav class="bg-white shadow-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <div class="flex items-center gap-6">
            <div class="flex items-center">
              <h1 class="text-xl font-bold text-cyan-600">AttendEase</h1>
              <span class="ml-4 text-sm text-gray-500">Admin Portal</span>
            </div>
            <div class="hidden md:flex gap-4">
              <a
                href="admin-dashboard.html"
                class="text-sm text-gray-600 hover:text-cyan-600 transition"
              >
                Dashboard
              </a>
              <a
                href="admin-users.html"
                class="text-sm text-gray-600 hover:text-cyan-600 transition"
              >
                Users
              </a>
              <a
                href="admin-subjects.html"
                class="text-sm text-cyan-600 font-semibold"
              >
                Subjects
              </a>
              <a
                href="admin-class-sections.html"
                class="text-sm text-gray-600 hover:text-cyan-600 transition"
              >
                Sections
              </a>
              <a
                href="admin-enrollments.html"
                class="text-sm text-gray-600 hover:text-cyan-600 transition"
              >
                Enrollments
              </a>
            </div>
          </div>
          <div class="flex items-center gap-4">
            <div class="text-right">
              <p id="user-name" class="text-sm font-semibold text-gray-900"></p>
              <p id="user-role" class="text-xs text-gray-500"></p>
            </div>
            <button
              onclick="logout()"
              class="text-sm text-red-600 hover:text-red-700 font-medium transition"
            >
              Logout
            </button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Header -->
      <div class="mb-8">
        <div class="flex justify-between items-center">
          <div>
            <h2 class="text-3xl font-bold text-gray-900">Manage Subjects</h2>
            <p class="text-gray-600 mt-1">
              Create, view, and manage course subjects
            </p>
          </div>
          <button
            onclick="openCreateModal()"
            class="px-6 py-3 bg-cyan-600 text-white rounded-lg hover:bg-cyan-700 font-medium shadow-md hover:shadow-lg transition"
          >
            + Create Subject
          </button>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow-sm p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600">Total Subjects</p>
              <p id="total-subjects" class="text-3xl font-bold text-gray-900 mt-2">0</p>
            </div>
            <div class="p-3 bg-cyan-100 rounded-lg">
              <svg class="w-8 h-8 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600">Active Subjects</p>
              <p id="active-subjects" class="text-3xl font-bold text-green-600 mt-2">0</p>
            </div>
            <div class="p-3 bg-green-100 rounded-lg">
              <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600">Departments</p>
              <p id="total-departments" class="text-3xl font-bold text-purple-600 mt-2">0</p>
            </div>
            <div class="p-3 bg-purple-100 rounded-lg">
              <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600">Avg Credits</p>
              <p id="avg-credits" class="text-3xl font-bold text-yellow-600 mt-2">0</p>
            </div>
            <div class="p-3 bg-yellow-100 rounded-lg">
              <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
              </svg>
            </div>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Search
            </label>
            <input
              type="text"
              id="search-input"
              placeholder="Search by code or name..."
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Department
            </label>
            <select
              id="department-filter"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
            >
              <option value="">All Departments</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Semester
            </label>
            <select
              id="semester-filter"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
            >
              <option value="">All Semesters</option>
              <option value="1">Semester 1</option>
              <option value="2">Semester 2</option>
              <option value="3">Semester 3</option>
              <option value="4">Semester 4</option>
              <option value="5">Semester 5</option>
              <option value="6">Semester 6</option>
              <option value="7">Semester 7</option>
              <option value="8">Semester 8</option>
            </select>
          </div>
          <div class="flex items-end">
            <button
              onclick="applyFilters()"
              class="w-full px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-900 transition"
            >
              Apply Filters
            </button>
          </div>
        </div>
      </div>

      <!-- Subjects Table -->
      <div class="bg-white rounded-lg shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th
                  class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider"
                >
                  Subject Code
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider"
                >
                  Subject Name
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider"
                >
                  Department
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider"
                >
                  Semester
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider"
                >
                  Credits
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider"
                >
                  Status
                </th>
                <th
                  class="px-6 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider"
                >
                  Actions
                </th>
              </tr>
            </thead>
            <tbody id="subjects-table-body" class="bg-white divide-y divide-gray-200">
              <!-- Subjects will be loaded here -->
            </tbody>
          </table>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-12">
          <svg
            class="mx-auto h-12 w-12 text-gray-400"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
            />
          </svg>
          <h3 class="mt-2 text-sm font-medium text-gray-900">No subjects found</h3>
          <p class="mt-1 text-sm text-gray-500">
            Get started by creating a new subject.
          </p>
        </div>
      </div>

      <!-- Pagination -->
      <div
        id="pagination"
        class="hidden mt-6 flex items-center justify-between"
      >
        <div class="text-sm text-gray-700">
          Showing <span id="showing-from" class="font-medium">1</span> to
          <span id="showing-to" class="font-medium">10</span> of
          <span id="total-count" class="font-medium">0</span> subjects
        </div>
        <div class="flex gap-2">
          <button
            id="prev-page"
            onclick="previousPage()"
            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Previous
          </button>
          <button
            id="next-page"
            onclick="nextPage()"
            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Next
          </button>
        </div>
      </div>
    </div>

    <script src="/js/utils.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script>
      let allSubjects = [];
      let filteredSubjects = [];
      let currentPage = 1;
      const subjectsPerPage = 10;

      // Initialize page
      async function initializePage() {
        checkAuth();
        const user = getCurrentUser();
        if (!user || user.role !== 'admin') {
          showToast('Access denied. Admin privileges required.', 'error');
          setTimeout(() => {
            window.location.href = '/login.html';
          }, 1500);
          return;
        }

        document.getElementById('user-name').textContent = `${user.firstName} ${user.lastName}`;
        document.getElementById('user-role').textContent = user.role.toUpperCase();

        await loadSubjects();
      }

      // Load all subjects
      async function loadSubjects() {
        showLoading();
        try {
          const response = await apiRequest('/admin/subjects', 'GET');
          allSubjects = response.subjects || [];
          filteredSubjects = [...allSubjects];
          
          updateStats();
          populateDepartmentFilter();
          renderSubjects();
          hideLoading();
        } catch (error) {
          hideLoading();
          showToast(error.message || 'Failed to load subjects', 'error');
        }
      }

      // Update stats
      function updateStats() {
        const totalSubjects = allSubjects.length;
        const activeSubjects = allSubjects.filter(s => s.isActive).length;
        const departments = new Set(allSubjects.map(s => s.department)).size;
        const avgCredits = totalSubjects > 0 
          ? (allSubjects.reduce((sum, s) => sum + s.credits, 0) / totalSubjects).toFixed(1)
          : 0;

        document.getElementById('total-subjects').textContent = totalSubjects;
        document.getElementById('active-subjects').textContent = activeSubjects;
        document.getElementById('total-departments').textContent = departments;
        document.getElementById('avg-credits').textContent = avgCredits;
      }

      // Populate department filter
      function populateDepartmentFilter() {
        const departments = [...new Set(allSubjects.map(s => s.department))].sort();
        const select = document.getElementById('department-filter');
        
        departments.forEach(dept => {
          const option = document.createElement('option');
          option.value = dept;
          option.textContent = dept;
          select.appendChild(option);
        });
      }

      // Render subjects table
      function renderSubjects() {
        const tbody = document.getElementById('subjects-table-body');
        const emptyState = document.getElementById('empty-state');
        const pagination = document.getElementById('pagination');

        if (filteredSubjects.length === 0) {
          tbody.innerHTML = '';
          emptyState.classList.remove('hidden');
          pagination.classList.add('hidden');
          return;
        }

        emptyState.classList.add('hidden');
        pagination.classList.remove('hidden');

        const startIndex = (currentPage - 1) * subjectsPerPage;
        const endIndex = startIndex + subjectsPerPage;
        const subjectsToShow = filteredSubjects.slice(startIndex, endIndex);

        tbody.innerHTML = subjectsToShow
          .map(
            (subject) => `
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-semibold text-cyan-600">${subject.subjectCode}</div>
            </td>
            <td class="px-6 py-4">
              <div class="text-sm font-medium text-gray-900">${subject.subjectName}</div>
              ${subject.description ? `<div class="text-xs text-gray-500 mt-1">${subject.description}</div>` : ''}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-600">${subject.department}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                Sem ${subject.semester}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-gray-900">${subject.credits}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${subject.isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                ${subject.isActive ? 'Active' : 'Inactive'}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              <button
                onclick="editSubject('${subject._id}')"
                class="text-cyan-600 hover:text-cyan-900 mr-3"
              >
                Edit
              </button>
              <button
                onclick="deleteSubject('${subject._id}', '${subject.subjectCode}')"
                class="text-red-600 hover:text-red-900"
              >
                Delete
              </button>
            </td>
          </tr>
        `
          )
          .join('');

        // Update pagination info
        document.getElementById('showing-from').textContent = startIndex + 1;
        document.getElementById('showing-to').textContent = Math.min(
          endIndex,
          filteredSubjects.length
        );
        document.getElementById('total-count').textContent = filteredSubjects.length;

        // Update pagination buttons
        document.getElementById('prev-page').disabled = currentPage === 1;
        document.getElementById('next-page').disabled =
          endIndex >= filteredSubjects.length;
      }

      // Open create modal
      function openCreateModal() {
        document.getElementById('modal-title').textContent = 'Create New Subject';
        document.getElementById('subject-form').reset();
        document.getElementById('edit-subject-id').value = '';
        document.getElementById('is-active').checked = true;
        document.getElementById('subject-modal').classList.remove('hidden');
      }

      // Close subject modal
      function closeSubjectModal() {
        document.getElementById('subject-modal').classList.add('hidden');
      }

      // Edit subject
      async function editSubject(subjectId) {
        const subject = allSubjects.find((s) => s._id === subjectId);
        if (!subject) return;

        document.getElementById('modal-title').textContent = 'Edit Subject';
        document.getElementById('edit-subject-id').value = subject._id;
        document.getElementById('subject-code').value = subject.subjectCode;
        document.getElementById('subject-name').value = subject.subjectName;
        document.getElementById('credits').value = subject.credits;
        document.getElementById('semester').value = subject.semester;
        document.getElementById('department').value = subject.department;
        document.getElementById('description').value = subject.description || '';
        document.getElementById('is-active').checked = subject.isActive;

        document.getElementById('subject-modal').classList.remove('hidden');
      }

      // Handle form submit
      document.getElementById('subject-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const editSubjectId = document.getElementById('edit-subject-id').value;

        const subjectData = {
          subjectCode: document.getElementById('subject-code').value,
          subjectName: document.getElementById('subject-name').value,
          credits: parseInt(document.getElementById('credits').value),
          semester: parseInt(document.getElementById('semester').value),
          department: document.getElementById('department').value,
          description: document.getElementById('description').value,
          isActive: document.getElementById('is-active').checked,
        };

        showLoading();
        try {
          if (editSubjectId) {
            // Update subject
            await apiRequest(`/admin/subjects/${editSubjectId}`, 'PUT', subjectData);
            showToast('Subject updated successfully', 'success');
          } else {
            // Create subject
            await apiRequest('/admin/subjects', 'POST', subjectData);
            showToast('Subject created successfully', 'success');
          }

          closeSubjectModal();
          await loadSubjects();
        } catch (error) {
          hideLoading();
          showToast(error.message || 'Failed to save subject', 'error');
        }
      });

      // Delete subject
      function deleteSubject(subjectId, subjectCode) {
        showConfirmModal(
          'Delete Subject',
          `Are you sure you want to delete ${subjectCode}? This action cannot be undone.`,
          async () => {
            showLoading();
            try {
              await apiRequest(`/admin/subjects/${subjectId}`, 'DELETE');
              showToast('Subject deleted successfully', 'success');
              await loadSubjects();
            } catch (error) {
              hideLoading();
              showToast(error.message || 'Failed to delete subject', 'error');
            }
          }
        );
      }

      // Apply filters
      function applyFilters() {
        const searchTerm = document
          .getElementById('search-input')
          .value.toLowerCase();
        const departmentFilter = document.getElementById('department-filter').value;
        const semesterFilter = document.getElementById('semester-filter').value;

        filteredSubjects = allSubjects.filter((subject) => {
          const matchesSearch =
            subject.subjectCode.toLowerCase().includes(searchTerm) ||
            subject.subjectName.toLowerCase().includes(searchTerm);

          const matchesDepartment = !departmentFilter || subject.department === departmentFilter;
          const matchesSemester = !semesterFilter || subject.semester == semesterFilter;

          return matchesSearch && matchesDepartment && matchesSemester;
        });

        currentPage = 1;
        renderSubjects();
      }

      // Pagination
      function previousPage() {
        if (currentPage > 1) {
          currentPage--;
          renderSubjects();
        }
      }

      function nextPage() {
        if (currentPage * subjectsPerPage < filteredSubjects.length) {
          currentPage++;
          renderSubjects();
        }
      }

      // Initialize when page loads
      document.addEventListener('DOMContentLoaded', initializePage);
    </script>
  </body>
</html>