<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Attendance - AttendEase</title>
    <link href="../../src/output.css" rel="stylesheet" />
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
      body {
        font-family: 'Inter', sans-serif;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Loading Overlay -->
    <div
      id="loading-overlay"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
    >
      <div class="bg-white p-6 rounded-lg shadow-xl">
        <div
          class="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-600 mx-auto"
        ></div>
        <p class="mt-4 text-gray-700">Loading attendance...</p>
      </div>
    </div>

    <!-- Navigation -->
    <nav class="bg-white shadow-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <div class="flex items-center gap-4">
            
              href="/pages/student/student-dashboard.html"
              class="text-gray-600 hover:text-cyan-600 transition"
              >← Back</a
            >
            <h1 class="text-xl font-bold text-cyan-600">AttendEase</h1>
          </div>
          <button
            onclick="logout()"
            class="text-sm text-red-600 hover:text-red-700 font-medium transition"
          >
            Logout
          </button>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Subject Header -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex justify-between items-start">
          <div>
            <h2 id="subject-code" class="text-2xl font-bold text-gray-900"></h2>
            <p id="subject-name" class="text-gray-600"></p>
          </div>
        </div>
      </div>

      <!-- Summary Card -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h3 class="text-lg font-semibold mb-4">Attendance Summary</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
          <div>
            <p class="text-sm text-gray-500">Total Classes</p>
            <p id="total-classes" class="text-3xl font-bold text-gray-900">0</p>
          </div>
          <div>
            <p class="text-sm text-gray-500">Total Sessions</p>
            <p id="total-sessions" class="text-3xl font-bold text-gray-900">
              0
            </p>
          </div>
          <div>
            <p class="text-sm text-gray-500">Present</p>
            <p id="present-count" class="text-3xl font-bold text-green-600">
              0
            </p>
          </div>
          <div>
            <p class="text-sm text-gray-500">Attendance %</p>
            <p id="attendance-percentage" class="text-3xl font-bold">0%</p>
          </div>
        </div>
      </div>

      <!-- Date Filters -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h3 class="text-lg font-semibold mb-4">Filter by Date</h3>
        <div class="flex gap-4 flex-wrap">
          <div class="flex-1 min-w-[200px]">
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Start Date</label
            >
            <input
              type="date"
              id="start-date"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 transition"
            />
          </div>
          <div class="flex-1 min-w-[200px]">
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >End Date</label
            >
            <input
              type="date"
              id="end-date"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 transition"
            />
          </div>
          <div class="flex items-end gap-2">
            <button
              onclick="applyDateFilter()"
              class="bg-cyan-600 text-white px-6 py-2 rounded-lg hover:bg-cyan-700 transition font-medium"
            >
              Apply
            </button>
            <button
              onclick="resetDateFilter()"
              class="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-300 transition font-medium"
            >
              Reset
            </button>
          </div>
        </div>
      </div>

      <!-- Attendance Records -->
      <div class="bg-white rounded-lg shadow-md">
        <div class="p-6 border-b">
          <h3 class="text-lg font-semibold">Attendance Records</h3>
        </div>
        <div id="records-container" class="p-6"></div>
      </div>
    </div>

    <script src="/js/constants.js"></script>
    <script src="/js/utils.js"></script>
    <script>
      let subjectId = null;

      document.addEventListener('DOMContentLoaded', async () => {
        const user = await checkAuth();
        if (user) {
          checkRole(user, ['student', 'admin']);
          const params = new URLSearchParams(window.location.search);
          subjectId = params.get('subjectId');
          if (!subjectId) {
            showErrorToast('Subject ID not found');
            setTimeout(
              () =>
                (window.location.href =
                  '/pages/student/student-dashboard.html'),
              2000
            );
            return;
          }
          await loadAttendance();
        }
      });

      async function loadAttendance(startDate = null, endDate = null) {
        showLoading();
        try {
          let url = `${API_CONFIG.BASE_URL}/students/attendance/subject/${subjectId}`;
          if (startDate && endDate) {
            url += `?startDate=${startDate}&endDate=${endDate}`;
          }

          const data = await apiRequest(url);
          hideLoading();

          const subject = data.data.subject;
          const summary = data.data.summary;
          const records = data.data.records;

          // Update subject info
          document.getElementById('subject-code').textContent =
            subject.subjectCode;
          document.getElementById('subject-name').textContent =
            subject.subjectName;

          // Animate summary numbers
          animateNumber(
            document.getElementById('total-classes'),
            summary.totalClasses
          );
          animateNumber(
            document.getElementById('total-sessions'),
            summary.totalSessions
          );
          animateNumber(
            document.getElementById('present-count'),
            summary.presentCount
          );

          // Update percentage with color
          const percentageEl = document.getElementById('attendance-percentage');
          percentageEl.textContent =
            summary.attendancePercentage.toFixed(2) + '%';
          percentageEl.className = `text-3xl font-bold ${
            getAttendanceColorClass(summary.attendancePercentage).split(' ')[0]
          }`;

          // Display records
          displayRecords(records);
        } catch (error) {
          hideLoading();
          showErrorToast(getUserFriendlyError(error.message));
        }
      }

      function displayRecords(records) {
        const container = document.getElementById('records-container');

        if (records.length === 0) {
          handleEmptyState(container, 'No attendance records found');
          return;
        }

        container.innerHTML = records
          .map(
            (record) => `
            <div class="mb-6 pb-6 border-b last:border-b-0">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-4 mb-4">
                    <div>
                        <p class="font-semibold text-gray-900">${record.date}</p>
                        <p class="text-sm text-gray-500">${record.startTime} - ${record.endTime} (${record.numSessions} sessions)</p>
                        <p class="text-sm text-gray-600 mt-1">Teacher: ${record.teacher.name}</p>
                    </div>
                    <div class="text-left sm:text-right">
                        <p class="text-2xl font-bold ${
                          getAttendanceColorClass(record.attendancePercentage)
                            .split(' ')[0]
                        }">
                            ${record.attendancePercentage.toFixed(2)}%
                        </p>
                        <p class="text-sm text-gray-500">${record.presentInThisClass}/${record.numSessions} present</p>
                    </div>
                </div>
                <div class="flex gap-2 flex-wrap">
                    ${record.sessions
                      .map(
                        (session) => `
                        <span class="px-3 py-1 rounded-lg text-sm font-medium ${
                          session.status === 'present'
                            ? 'bg-green-100 text-green-800'
                            : 'bg-red-100 text-red-800'
                        }">
                            ${session.status === 'present' ? '✓' : '✗'} Session ${session.sessionNumber}
                            <span class="text-xs ml-1">(${session.time})</span>
                        </span>
                    `
                      )
                      .join('')}
                </div>
            </div>
        `
          )
          .join('');
      }

      function applyDateFilter() {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;

        if (!startDate || !endDate) {
          showWarningToast('Please select both start and end dates');
          return;
        }

        const formattedStart = formatDateFromInput(startDate);
        const formattedEnd = formatDateFromInput(endDate);

        loadAttendance(formattedStart, formattedEnd);
      }

      function resetDateFilter() {
        document.getElementById('start-date').value = '';
        document.getElementById('end-date').value = '';
        loadAttendance();
      }
    </script>
  </body>
</html>